<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>添加银行卡</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
  <style type="text/css">
        *{
            margin: 0;
            padding: 0;
        }
        body{
            font-family: '微软雅黑';
            background:#efeff2;
        }
        .brown-border{
        	height:10px;
        	width:100%;
        }
        .card-type{
        	background:#fff;
        	margin-bottom:10px;
        	height:50px;
        	width:100%;
        	border-top:1px solid #D8D8D8;
        	border-bottom:1px solid #D8d8d8;
        }
        .card-type-inner{
        	margin-left:12px;
        	margin-right:12px;
        	line-height:50px;
        	font-size:16px;
        	color:#333333;
        }
        .card-type-inner >input{
        	font-size: 16px;
            width:65%;
            line-height:16px;
            text-indent:39px; 
            font-family:'arial';

            margin-left: 12px;
            outline: none;
        }
        .card-type-font{
        	float:left;
        }
        .card-type-arrow{
        	float:right;
        }
        .brown-border >span{
        	font-size:16px;
        	margin-left:12px;
        	line-height:30px;
        	color:#a1a1a1;
        }
        .addbankform{
        	background:#fff;
            width: 100%;
            height: 150px;
            border-top: 1px solid #D8D8D8;
            border-bottom: 1px solid #D8D8D8;
        }
        .addbankform .kalis{
        	position:relative;
            height: 50px;
            line-height: 46px;
            margin-left: 12px;
            margin-right: 12px;
        }
        .addbankform .kalis .kahao{
            font-size: 16px;
            position:absolute;
        }
        .addbankform .kalis > input{
            font-size: 16px;
            width:100%;
            line-height:50px;
            text-indent:39px; 
            font-family:'arial';

            margin-left: 12px;
            outline: none;
        }
        .icons-div{
        	height: 100%;
		    text-align: center;
		    position: absolute;
		    width: 35px;
        	right:0;
            top:0;
            position:absolute;
        }
        .icons1{
            background: url('../../image/icons1.png') no-repeat;
            width: 20px;
            height: 20px;
            background-position: 50% 40%;
            border-radius: 50%;
            margin-top: 16px;
        }
        .solid{
        	border-bottom:1px solid #EFEFF2;
        }
         #btns{
             width: 100%;
             margin-top: 20px;
        }
        #btns .btn{
             height: 50px;
             margin: 0 20px;
             text-align: center;
             font-size: 18px;
             border-radius: 4px;
             background: #c9c9c9;
             color: #fff;
             line-height: 50px;
        }
    </style>
</head>
<body>
	<div class="brown-border"></div>
	<div class="card-type">
		<div class="card-type-inner">
			<span class="card-type-font">持卡行</span>
			<span class="card-type-arrow">**</span>
			<input type="text" id="card_bank" readonly=""/>
		</div>
	</div>
    <div class="addbankform">
        <div class="kalis solid">
	            <span class="kahao">持卡人</span>
	            <input type="text" id="card_name" placeholder="持卡人姓名" readonly="" />
        </div>
        <div class="kalis solid">
            <span class="kahao">身份证</span>
            <input type="text" id="id_no" placeholder="身份证" maxlength="18"/>
        </div>
        <div class="kalis">
            <span class="kahao">手机号</span>
            <input type="tel" id="card_phone" placeholder="银行卡绑定手机号" maxlength="11"/>
        </div>
        <input type="hidden" id="card_no" />
    </div>
     <div id="btns" tapmode=""  >
      <div class="btn">下一步</div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
	apiready=function(){
		$api.val($api.byId("card_bank"),api.pageParam.card_bank);
		$api.val($api.byId("card_name"),api.pageParam.card_name);
		$api.val($api.byId("card_no"),api.pageParam.card_no);
		$api.addEvt($api.dom('body'),'input',function(){
			var card_bank=$api.val($api.byId('card_bank'));
			var card_name=$api.val($api.byId('card_name'));
			var id_no=$api.val($api.byId('id_no'));
			var card_phone=$api.val($api.byId('card_phone'));
			if(card_bank!='' && card_name!='' && $api.trimAll(id_no)!='' && $api.trimAll(card_phone)!=''){
				$api.attr($api.dom('.btn'),'style','background:#0da4ff');
				$api.attr($api.dom('.btn'),'onclick','submit()');
			}else{
				$api.attr($api.dom('.btn'),'style','background:#c9c9c9');
				$api.attr($api.dom('.btn'),'onclick','');
			}
		});
	}
	var submit=function(){
			var card_bank=$api.val($api.byId('card_bank'));
			var card_name=$api.val($api.byId('card_name'));
			var id_no=$api.val($api.byId('id_no'));
			var card_no=api.pageParam.card_no;
			var card_phone=$api.val($api.byId('card_phone'));
			if(card_bank==''){
				api.toast({msg:'持卡行未选择！',location:'middle'});
			}else if(card_name==''){
				api.toast({msg:'持卡人未填写！',location:'middle'});
			}else if($api.trimAll(id_no)=='' || $api.trimAll(id_no).length!=18 || IdCardValidate($api.trimAll(id_no))==false){
				api.toast({msg:'身份证格式不对！',location:'middle'});
			}else if($api.trimAll(card_phone)=='' || $api.trimAll(card_phone).length!=11){
				api.toast({msg:'手机号格式不对！',location:'middle'});
			}else{
				api.getPrefs({
	                key:'userid'
                },function(ret,err){
                	if(ret!='' && ret){
                		api.ajax({
			                url:'http://192.168.0.188:8899/index.php/vip/bondcard',
			                method:'post',
			                dataType:'json',
			                returnAll:true,
			                data:{values:{
			                	vipid:ret.value,
			                	bank_name:card_bank,
			                	owner_name:card_name,
			                	card_no:card_no,
			                	id_no:id_no,
			                	card_phone:card_phone
			                }}
		                },function(ret,err){
		                	if(ret){
		                		if(ret.body.result==false && ret.body.msg=='same'){
		                			api.toast({
	                                    msg:'该卡已经绑定，请不要重复添加',
	                                    location:'middle'
                                    });
		                		}else if(ret.body.result==false && ret.body.msg=='fail'){
		                			api.toast({
	                                    msg:'添加失败，请重新添加',
	                                    location:'middle'
                                    });
		                		}else if(ret.body.result==true){
		                			api.toast({
	                                    msg:'添加成功！',
	                                    location:'middle'
                                    });
                                    setTimeout(function(){
                                    	api.execScript({
                                    		name:'mybank',
                                    		frameName:'mybank_body',
	                                        script: 'reload();'
                                        });
                                        api.closeToWin({
                                        	name:'mybank',
                                        	duration:0,
                                        	animation:{
                                        		type:'none'
                                        	}
                                        });
                                    },1000);
		                		}
		                	}
		                });
                	}
                });
				
			}
	}
	
	/*
	 * 验证身份证
	 */
	var Wi = [ 7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2, 1 ];    // 加权因子   
	var ValideCode = [ 1, 0, 10, 9, 8, 7, 6, 5, 4, 3, 2 ];            // 身份证验证位值.10代表X   
	function IdCardValidate(idCard) { 
	    idCard = trim(idCard.replace(/ /g, ""));               //去掉字符串头尾空格                     
	    if (idCard.length == 15) {   
	        return isValidityBrithBy15IdCard(idCard);       //进行15位身份证的验证    
	    } else if (idCard.length == 18) {   
	        var a_idCard = idCard.split("");                // 得到身份证数组   
	        if(isValidityBrithBy18IdCard(idCard)&&isTrueValidateCodeBy18IdCard(a_idCard)){   //进行18位身份证的基本验证和第18位的验证
	            return true;   
	        }else {   
	            return false;   
	        }   
	    } else {   
	        return false;   
	    }   
	}   
/**  
 * 判断身份证号码为18位时最后的验证位是否正确  
 * @param a_idCard 身份证号码数组  
 * @return  
 */  
function isTrueValidateCodeBy18IdCard(a_idCard) {   
    var sum = 0;                             // 声明加权求和变量   
    if (a_idCard[17].toLowerCase() == 'x') {   
        a_idCard[17] = 10;                    // 将最后位为x的验证码替换为10方便后续操作   
    }   
    for ( var i = 0; i < 17; i++) {   
        sum += Wi[i] * a_idCard[i];            // 加权求和   
    }   
    valCodePosition = sum % 11;                // 得到验证码所位置   
    if (a_idCard[17] == ValideCode[valCodePosition]) {   
        return true;   
    } else {   
        return false;   
    }   
}   
/**  
  * 验证18位数身份证号码中的生日是否是有效生日  
  * @param idCard 18位书身份证字符串  
  * @return  
  */  
function isValidityBrithBy18IdCard(idCard18){   
    var year =  idCard18.substring(6,10);   
    var month = idCard18.substring(10,12);   
    var day = idCard18.substring(12,14);   
    var temp_date = new Date(year,parseFloat(month)-1,parseFloat(day));   
    // 这里用getFullYear()获取年份，避免千年虫问题   
    if(temp_date.getFullYear()!=parseFloat(year)   
          ||temp_date.getMonth()!=parseFloat(month)-1   
          ||temp_date.getDate()!=parseFloat(day)){   
            return false;   
    }else{   
        return true;   
    }   
}   
  /**  
   * 验证15位数身份证号码中的生日是否是有效生日  
   * @param idCard15 15位书身份证字符串  
   * @return  
   */  
  function isValidityBrithBy15IdCard(idCard15){   
      var year =  idCard15.substring(6,8);   
      var month = idCard15.substring(8,10);   
      var day = idCard15.substring(10,12);   
      var temp_date = new Date(year,parseFloat(month)-1,parseFloat(day));   
      // 对于老身份证中的你年龄则不需考虑千年虫问题而使用getYear()方法   
      if(temp_date.getYear()!=parseFloat(year)   
              ||temp_date.getMonth()!=parseFloat(month)-1   
              ||temp_date.getDate()!=parseFloat(day)){   
                return false;   
        }else{   
            return true;   
        }   
  }   
//去掉字符串头尾空格   
function trim(str) {   
    return str.replace(/(^\s*)|(\s*$)/g, "");   
}
</script>
</html>