<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>在线还款</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
<style>
        *{
            margin: 0;
            padding: 0;
        }
    	body{
    		font-size: 12px;
             font-family: "Helvetica Neue", Helvetica, STHeiTi, sans-serif;
            background: #EAEAEC;
    	}
        .huankuan{
            width: 100%;
            height: 50px;
            line-height: 50px;
            background: #fff;
            margin-top: 10px;
            text-indent: 20px;
            font-size: 14px;
        }
        .h_1{
            font-size: 14px;
            color: #666;
            height: 14px;
            display: block;
            float: left;
            line-height: 14px;
            text-align: center;
            margin-top: 18px;
        }
        .num1{
            font-size: 16px;
            color: #000;
            height: 16px;
            display: block;
            float: left;
            line-height: 16px;
            margin-top: 17px;
            font-weight:bold;
            color:#fd0000;
            text-align: center;
        }
        .zhifulist{
            width: 100%;
            background-color: #fff;
            margin-top: 10px;
        }
        .container{
            margin-left: 20px;
            margin-right: 20px;
            border: 1px solid red;
        }
        /*list01*/
        .z_1{
            border-bottom: 1px solid #D8D8D8;
            height: 50px;
            position: relative;
        }
        .z_1 .c_1{
            margin-left: 20px;
            margin-right: 20px;
            height: 50px;
        }
        .weichaticon{
            width: 32px;
            height: 32px;
            display: block;
            background: url('../../image/wechat.png') no-repeat;
            margin-top: 9px;
            background-size: 90%;
            background-position: 50% 50%;
            float: left;
        }
        .jianshe{
            width: 32px;
            height: 32px;
            display: block;
            background: url('../../image/alipay.png') no-repeat;
            margin-top: 9px;
            background-size: 90%;
            background-position: 50% 50%;
            float: left;
        }
        .yinhangka{
            width: 32px;
            height: 32px;
            display: block;
            background: url('../../image/bankpay.png') no-repeat;
            margin-top: 9px;
            background-size: 90%;
            background-position: 50% 50%;
            float: left;
        }
        .wei_zhifu{
            height: 16px;
            font-size: 16px;
            margin-left: 48px;
            line-height: 14px;
            margin-top: 8px;
            display: block;
            padding-top: 10px;
        }
        .wei_info{
            font-size: 12px;
            color: #999;
            height: 12px;
            display: inline-block;
            line-height: 12px;
            margin-left: 14px;
            margin-top: 4px;
        }
        .check{
            width: 18px;
            height: 18px;
            background: #0DA4FF;
            border-radius: 50%;
            line-height: 18px;
            text-align: center;
            color: #fff;
            position: absolute;
            right: 20px;
            top: 16px;
        }
        .check2 , .check3{
            background: #fff;
            border: 1px solid #999;
            width: 17px;
            height: 17px;
            top: 14px;
        }
        /*list01 end*/
        /*btns*/
        #btns{
            width: 100%;
            height: 50px;
        }
        #btns #btn{
            height: 50px;
            margin: 20px 20px 0 20px;
            background: #0DA4FF;
            color: #fff;
            font-size: 18px;
            line-height: 50px;
            text-align: center;
            border-radius: 6px;
        }
        .aaa{color:#ff6600;}
    </style>
</head>
<body>
	<div class="huankuan">
        <span class="h_1">本次还款(元)</span>
        <span class="num1" id="pay_amount">0.00</span>
    </div>
    <!-- zhifu组件 -->
    <div class="zhifulist">
    
    		<div class="z_1" tapmode="" onclick="choosePay('alipay')">
                <div class="c_1" id="alipay">
                    <span class="jianshe"></span>
                    <span class="wei_zhifu">支付宝支付</span>
                    <span class="wei_info">更方便的支付方式</span>
                    <div class="check">√</div>
                </div>
            </div>
    <!--
            <div class="z_1" tapmode="" onclick="choosePay('wxpay')">
                <div class="c_1" id="wxpay">
                    <span class="weichaticon"></span>
                    <span class="wei_zhifu">微信支付</span>
                    <span class="wei_info">推荐安装微信5.0及以上版本的使用</span>
                    <div class="check check2">√</div>
                </div>
            </div>
    -->
            <input type="hidden" value="alipay" id="paytype"/>
    </div>
    <!-- btn组件 -->
    <div id="btns" tapmode="" onclick="submit()">
        <div id="btn">确定还款</div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
	var submit=function(){
		var paytype=$api.val($api.byId('paytype'));
		if(paytype=='wxpay'){
				wx_pay();
				//微信支付结束	
		}else if(paytype=='alipay'){
			//获取用户的vipid
			var vip_account = $api.getStorage('vip_account');
			var vipid =vip_account.data.vipid; 
			//支付宝支付
			var obj = api.require('aliPay');
			var subject = '天天分期还款';
			var body = 'TTFQ'+'_'+vipid+'_'+api.pageParam.hkqs+'_'+api.pageParam.hkid;
			var amount = api.pageParam.prepay_amount
			var tradeNO = '2015092915251222'+Math.ceil(Math.random()*100);
			var notifyURL = $api.getStorage('request_url')+'/pay/alipay_notify_url';
			obj.config({
			  partner:'2088711133804888',
			  seller:'wangxiaodong@kaitucf.com',
			  rsaPriKey:'MIICdQIBADANBgkqhkiG9w0BAQEFAASCAl8wggJbAgEAAoGBAL8n2XeGra4+EKbqx18jC0wThM00/E1HsD0mSat288g1Ex7IB+KcQq9eWdiHeFCqB0K5Xc9AkT24WV5neuN2sRVYxwinEg4rYsox6VmlPLVb17HY/yaHj6lRzTZRZ8ohZszPTUW6Ah6CBWPi+0Sik48s8E6vfAtXxkkO1Lv0DT+nAgMBAAECgYBLjwPdxCWI102bvPfbui1v/9Mhjg0guvKF6Ul7dkR8YcZSB31ebKfLS/81oK7FK8A89qqHDp2aiPECaOLhYHw0JaKN2W2tUAdOj5IW619MkRzQVva4Znv60xblsFKyuYFbumkqxbP0Gyn5YUnWe+wx/b4Deh/tKY+RqhkClttE0QJBAOx8rRUX7bVJjKImTdfNXfLqu1FT8SqmT8tqHaK8f4QrLdxGLqZgjpJyNJVQASxGD+rt9P2ga6ooVhTX8WljA78CQQDO7aM0+EqQCxVP9KFlRhLfT7ZEjsiRLNAXdiHAhcSeW9Cjvkur3rw/KneKRlaWL6I93lPNtkadS00x6hZPbp4ZAkB5E/RCAnhQAxIfyuC8Bod9YbT6FLI7Fd9w1CnMMhpPfxQB3WTxBiq4zAQkFkwjcNOhgqeWW1YETpaUIWOWg31dAkAVws/jBilxNHktS2CdsdzSNyPH2ewluDy5+uZZxLeEn8s1LRHwJSBO1Dx2Aieg66l4MCVIAN80M3MOyLtH5y4hAkBjl1nizrX3iAxOOv7ILWQRxBPFITN0mH+t71gcw//m0nWWmM6ywVfREVE6NHANxqgvKzc3GQBh2EX+SpbIjJ8P',
			  rsaPubKey:'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnxj/9qwVfgoUh/y2W89L6BkRAFljhNhgPdyPuBV64bfQNN1PjbCzkIM6qRdKBoLPXmKKMiFYnkd6rAoprih3/PrQEB/VsW8OoM8fxn67UDYuyBTqA23MML9q1+ilIZwBC2AQ2UBVOrFXfFl75p6/B5KsiNG9zpgmLCUYuLkxpLQIDAQAB',
			  notifyURL:notifyURL
			},function(ret,err) {
			});
			obj.pay({
			    subject:subject,
			    body:body,
			    amount:amount,
			    tradeNO:tradeNO
			},function(ret,err) {
			    if(ret.code=='9000'){
			    	api.alert({
			    		title:'支付结果',
			    		msg:'您已支付成功！',
			    		buttons:['确认']
			    	},function(ret,err){
			    		if(ret.buttonIndex==1){
			    			api.execScript({
			    				name:'mybill',
			    				frameName:'mybill_body',
	                            script: 'reload();'
                            });
                            setTimeout(function(){
				    			api.openWin({
		                            name: 'mybill',
		                            reload:true,
		                            animation:{
		                            	type:'movein',
		                            	subType:'from_right',
		                            	duration:300
		                            }
	                            });
	                         },1000);
                            api.closeWin({
                            	name:'pay',
                            	animation:{
                            		duration:0
                            	}
                            });
			    		}
			    	})
			    }else if(ret.code=='0001' || ret.code=='0002' ||ret.code=='0003'){
			    	api.alert({
			    		title:'支付结果',
			    		msg:'您当前支付环境有误,请更换其他支付方式！',
			    		buttons:['确认']
			    	},function(ret,err){
			    		if(ret.buttonIndex==1){
			    			api.openWin({
	                            name: 'mybill',
	                            reload:true,
	                            animation:{
	                            	type:'movein',
	                            	subType:'from_right',
	                            	duration:300
	                            }
                            });
                            api.closeWin({
                            	name:'pay_body',
                            	animation:{
                            		duration:0
                            	}
                            });
			    		}
			    	})
			    }else{
			    	api.alert({
			    		title:'支付结果',
			    		msg:'支付数据有误，请重试！',
			    		buttons:['确认']
			    	},function(ret,err){
			    		if(ret.buttonIndex==1){
			    			api.openWin({
	                            name: 'mybill',
	                            reload:true,
	                            animation:{
	                            	type:'movein',
	                            	subType:'from_right',
	                            	duration:300
	                            }
                            });
                            api.closeWin({
                            	name:'pay_body',
                            	animation:{
                            		duration:0
                            	}
                            });
			    		}
			    	})
			    }
			    
			});
		}
	}
	var choosePay=function(paytype){
		if($api.hasCls($api.dom('#alipay .check'),'check2')){	
		}else{
			$api.addCls($api.dom('#alipay .check'),'check2');
		}
		if($api.hasCls($api.dom('#wxpay .check'),'check2')){	
		}else{
			$api.addCls($api.dom('#wxpay .check'),'check2');
		}
		if($api.hasCls($api.dom('#bankpay .check'),'check2')){	
		}else{
			$api.addCls($api.dom('#bankpay .check'),'check2');
		}
		$api.removeCls($api.dom('#'+paytype+' .check'),'check2');
		$api.val($api.byId('paytype'), paytype);
	}
	apiready=function(){
		$api.text($api.byId('pay_amount'),api.pageParam.prepay_amount+'.00');
		setTimeout(function(){
			api.closeWin({
            	name:'pay'
            });
		},1000*60*10)
	}
	
function wx_pay(){
        api.ajax({
                url : $api.getStorage('request_url')+"/wxpay/pay",
                method : 'POST',
                timeout : '30',
                dataType : 'json',
                returnAll : false,
                cache :true,
                data:
                {
                        values:{type:"login"}
                }
        },
        function(ret, err){
            alert(JSON.stringify(ret));
                if (ret){
                        var back_info=ret;
                        var weiXin = api.require('weiXin');
                        weiXin.registerApp(
                            function(ret,err){
                                if (ret.status){
                                        weiXin.payOrder({
                                            orderId:back_info.prepayid,
                                            partnerId:back_info.partnerid,
                                            nonceStr:back_info.noncestr,
                                            timeStamp:back_info.timestamp,
                                            package:back_info.package,        
                                            sign:back_info.sign
                                            },function(ret,err){
                                                 if (ret.status){
                                                         alert('支付成功');
                                                 }else{
                                                         alert(err.msg);
                                                         alert('支付失败！')
                                                 }
                                            });
                                }else{
                                        alert(err.msg);
                                }
                            }
                        );
                }else{
                        alert(JSON.stringify(err));
                }
        });
}
</script>
</html>