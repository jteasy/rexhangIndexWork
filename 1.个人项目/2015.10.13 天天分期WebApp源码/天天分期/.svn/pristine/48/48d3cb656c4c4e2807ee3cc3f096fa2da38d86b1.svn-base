<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>添加银行卡</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
   <style type="text/css">
        *{
            margin: 0;
            padding: 0;
        }
        body{
            font-family: "Helvetica Neue", Helvetica, STHeiTi, sans-serif;
            background:#efeff2;
        }
        input{
            font-size: 14px;
            line-height: none;
        }
        .brown-border{
            height:30px;
            width:100%;
        }
        .brown-border >span{
            font-size:14px;
            margin-left:12px;
            line-height:30px;
            color:#a1a1a1;
        }
        .addbankform{
            background:#fff;
            width: 100%;
            height: 98px;
            border-top: 1px solid #D8D8D8;
            border-bottom: 1px solid #D8D8D8;
        }
        .addbankform .kalis{
            position:relative;
            height: 46px;
            line-height: 46px;
            margin-left: 12px;
            margin-right: 12px;
        }
        .addbankform .kalis .kahao{
            font-size: 14px;
            position:absolute;
            display: inline-block;
            width: 50px;
        }
        .addbankform .kalis > input{
            font-size: 14px;
            width: calc(100% - 46px);
            height: 46px;
            outline: none;
            position: absolute;
            left: 58px;
        }
        .icons-div{
            height: 100%;
            text-align: center;
            position: absolute;
            width: 35px;
            right:0;
            top:0;
            position:absolute;
        }
        .icons1{
            background: url('../../image/icons1.png') no-repeat;
            width: 20px;
            height: 20px;
            background-position: 50% 40%;
            border-radius: 50%;
            margin-top: 16px;
        }
        .solid{
            border-bottom:1px solid #EFEFF2;
        }
         #btns{
             width: 100%;
             margin-top: 20px;
        }
        #btns .btn{
             height: 50px;
             margin: 0 20px;
             text-align: center;
             font-size: 18px;
             border-radius: 4px;
             background: #c9c9c9;
             color: #fff;
             line-height: 50px;
        }
        .near{
            width: 100%;
            border-bottom: 1px solid #fff;
        }
    </style>
</head>
<body>
	<div class="brown-border">
		<span>请绑定您本人的银行卡</span>
	</div>
    <div class="addbankform">
	    <div class="near">
	        <div class="kalis solid">
		            <span class="kahao">持卡人</span>
		            <input type="text" id="card_name" placeholder="持卡人姓名" maxlength="30" />
	            	<div class="icons-div" tapmode="" onclick="alertinfo()"><span class="icons1"></span></div>
	        </div>
	    </div>
	    <div class="near1">
	        <div class="kalis">
	            <span class="kahao">卡号</span>
	            <input type="tel" id="card_no" placeholder="银行卡号" maxlength="28" onkeyup="this.value=this.value.replace(/\D/g,'').replace(/....(?!$)/g,'$& ')"/>
	        </div>
	    </div>
    </div>
     <div id="btns" tapmode="" >
      <div class="btn">下一步</div>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
	var alertinfo=function(){
		api.alert({
			title:'持卡人说明',
			msg:'为保证资金按时到帐，只能绑定您本人银行卡',
			buttons:['知道了']
        },function(ret,err){
        	//coding...
        });
	}
	var openWin=function($url){
		api.openWin({
	        name:$url,
	        url: $url+'_header.html',
	        bgcolor:"#ffffff",
	        scrollToTop:true,
	        animation:{
	        	type:'movein',
	        	subType:'from_right'
	        }
        });
	}
	var submit=function(){
		/*
		 * 首先把银行卡数据发送到url查询格式以及银行开户行
		 */
		var card_name=$api.val($api.byId("card_name"));
		var card_no=$api.trimAll($api.val($api.byId("card_no")));
		api.ajax({
	        url:'https://ccdcapi.alipay.com/validateAndCacheCardInfo.json?_input_charset=utf-8&cardNo='+card_no+'&cardBinCheck=true',
	        dataType:'json',
	        method:'get'
        },function(ret,err){
        	if(ret){
        		var cardinfo=ret;
        		var validated=ret.validated;
        		if(validated==false){
        			api.toast({
	                    msg:'该卡暂不支持提现卡绑定，请用其他卡'
                    });
                    return false;
        		}
        		var cardtype=ret.cardType;
        		if(cardtype!='DC'){
        			api.toast({
	                    msg:'该卡暂不支持提现卡绑定，请用其他卡'
                    });
                    return false;
        		}
        		//alert(JSON.stringify(ret));
        		api.readFile({
	                path:'widget://res/bank.json'
                },function(ret,err){
                	var banklist=$api.strToJson(ret.data);
                	var cardinfos=(cardinfo.bank).toLowerCase();

                			var thisbank=banklist[cardinfos];
                			api.openWin({
	                            name: 'addbank_second',
	                            url: 'addbank_second_header.html',
	                            pageParam:{
	                            	card_name:card_name,
	                            	card_bank:thisbank,
	                            	card_no:card_no
	                            },
	                            scrollToTop:true,
	                            animation:{
	                            	type:'movein',
	                            	subType:'from_type',
	                            	duration:300
	                            }
                            });

                });
        		
        	}
        });
	}
	
	
	/*$api.addEvt($api.byId("card_no"),'input',function(){
		var card=$api.trimAll($api.val($api.byId('card_no')));
		if(card.length>4 && card!="" &card.length%4!=0){
			var $temp_str='';
			var startpos=0;
			for(var i=1;i<parseInt(card.length/4)+1;i++){
				$temp_str+=card.substring(startpos,startpos+4)+' ';
				startpos+=4;
			}
			$temp_str+=card.substring((card.length-card.length%4),card.length+1);
		}else if(card.length>4 && card!="" && card.length%4==0){
			var $temp_str='';
			var startpos=0;
			for(var i=1;i<parseInt(card.length/4)+1;i++){
				$temp_str+=card.substring(startpos,startpos+4)+' ';
				startpos+=4;
			}
			$temp_str=$api.trim($temp_str);
		}else if(card.length<=4){
			var $temp_str=card;
		}
		$api.val($api.byId("card_no"), $temp_str);
	    document.getElementById("card_no").setSelectionRange($temp_str.length,$temp_str.length);  
	    document.getElementById("card_no").focus();   
	});*/
	/*侦听全局input事件，用来控制按钮颜色和是否可点击*/
	$api.addEvt($api.dom('body'),'input',function(){
		var card_name=$api.trimAll($api.val($api.byId("card_name")));
		var card_no=$api.trimAll($api.val($api.byId("card_no")));
		if(card_name!="" && card_no!=""){
			$api.attr($api.dom(".btn"),'style','background:#0da4ff');
			$api.attr($api.dom(".btn"),'onclick','submit()');
		}else{
			$api.attr($api.dom(".btn"),'style','background:#c9c9c9');
			$api.attr($api.dom(".btn"),'onclick','');
		}
	});
</script>
</html>